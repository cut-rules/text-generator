var tracery={createGrammar:function(r){return new tracery.Grammar(r)}},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"==typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r};tracery.Grammar=function(){function r(t){return i(t)||Object.keys(t).map(function(r){return t[r]})}function t(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}var e=function(){function r(r,t){for(var e=0;e<t.length;e++){var a=t[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(r,a.key,a)}}return function(t,e,a){return e&&r(t.prototype,e),a&&r(t,a),t}}();return function(){function i(e){t(this,i),this.raw=e||{},this.symbols={},this.subgrammars=[],this.errors=[],this.modifiers={}}return e(i,[{key:"addModifiers",value:function(r){for(var t in r)if(r.hasOwnProperty(t)){if(this.modifiers[t])throw"Already a modifier named ".concat(t);this.modifiers[t]=r[t]}}},{key:"createRoot",value:function(r,t){return new tracery.Node(this,{type:"root",raw:r,context:t})}},{key:"expand",value:function(r,t){var e=new tracery.Node(this,{type:"root",raw:r,context:t});return e.expand(),e.finishedText}},{key:"flatten",value:function(r){return this.expand(r)}},{key:"toJSON",value:function(){return JSON.stringify(this.raw)}},{key:"loadFromRawObj",value:function(t){this.raw=t,this.symbols={},this.subgrammars=[];for(var e in t)this.symbols[e]=new tracery.Symbol(this,e,t[e])}},{key:"clearState",value:function(){for(var r in this.symbols)this.symbols[r].clearState()}}]),i}()}();tracery.Symbol=function(){function r(e,a,i){t(this,r),this.grammar=e,this.key=a,this.rawRules=i,this.baseRules=null,this.clearState()}return e(r,[{key:"clearState",value:function(){this.uses=0,this.baseRules=r.flattenRules(this.rawRules),this.stack=[]}},{key:"getActiveRules",value:function(){return this.stack.length>0?this.stack[this.stack.length-1]:this.baseRules}},{key:"selectRule",value:function(r,t){var e=this.getActiveRules();return 0!==e.length?tracery.selectFrom(e):null}},{key:"pushRules",value:function(r,t){var e=void 0;if("string"==typeof r)e=r;else{if(!(r instanceof Array))throw"Cannot interpret rules "+r+" for "+t;for(var a=[],i=0;i<r.length;i++)a[i]="string"==typeof r[i]?r[i]:r[i].type;r=a}this.stack.push(e)}},{key:"popRules",value:function(){this.stack.pop()}},{key:"staticAnalyze",value:function(){}},{key:"toJSON",value:function(){return JSON.stringify(this.rawRules)}}],[{key:"flattenRules",value:function(t){return"string"==typeof t?[t]:t}}]),r}();tracery.Node=function(){function r(e,a){t(this,r),this.grammar=e,this.errors=[],this.finished=!1,this.childText="","string"==typeof a?(this.type="plaintext",this.raw=a,this.finished=!0,this.finishedText=this.raw):this.raw=a}return e(r,[{key:"expand",value:function(){if(!this.finished){if(this.type)throw"Already expanded";this.children=[],"string"==typeof this.raw?(this.type="plaintext",this.finishedText=this.raw):(this.type=this.raw.type,this.raw.type);var r=this;switch(this.type){case"plaintext":this.finishedText=this.raw.raw;break;case"tag":if(this.symbol=this.grammar.symbols[this.raw.symbol],!this.symbol)throw"Missing symbol "+this.raw.symbol;var t=this.symbol.selectRule();this.children.push(new r(this.grammar,{type:"rule",raw:t,context:this})),this.children[0].expand(),this.finishedText=this.children[0].finishedText;break;case"rule":this.childText=this.raw,this.children.push(new r(this.grammar,this.childText)),this.children[0].expand(),this.finishedText=this.children[0].finishedText;break;case"root":this.childText=this.raw.raw,this.children.push(new r(this.grammar,this.childText)),this.children[0].expand(),this.finishedText=this.children[0].finishedText}this.finished=!0}}}]),r}();tracery.selectFrom=function(r){return r[Math.floor(Math.random()*r.length)]};